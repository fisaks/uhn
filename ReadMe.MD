# Unified Home Network

> ðŸš§ **WORK IN PROGRESS** ðŸš§

A personal project to create an open, distributed automation platformâ€”  
one day replacing my aging IHC installation with something I control, extend, and trust.

My aim is to build a flexible replacement for my legacy IHC setupâ€”capable of supporting both wired (e.g. Modbus, GPIO, IÂ²C) and wireless (e.g. Zigbee) devices, with no artificial hardware limits.

**Not limited by vendor, protocol, or device count.**

The goal is something like this
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                BROWSER                                       â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    UHN UI (React app)                                  â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  - Runs in browser                                                     â”‚  â”‚
â”‚  â”‚  - Loaded through UXP                                                  â”‚  â”‚
â”‚  â”‚  - Talks to UHN Master via REST + WebSocket                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ REST / WebSocket
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               UHN MASTER                                     â”‚
â”‚                        (Node.js / UXP remote app)                            â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ REST API                                                               â”‚  â”‚
â”‚  â”‚ WebSocket API                                                          â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚ - Blueprint upload / management                                        â”‚  â”‚
â”‚  â”‚ - Global coordination                                                  â”‚  â”‚
â”‚  â”‚ - Rule placement (master vs edge)                                      â”‚  â”‚
â”‚  â”‚ - State aggregation from edges                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MQTT Broker (Master-local)                                             â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚ - Receives state/events from edges                                     â”‚  â”‚
â”‚  â”‚ - Sends commands / assignments to edges                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Go Sandbox Launcher (local)                                            â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ WORKER (Node.js, sandboxed)                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - Executes rules assigned to master                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - Read-only state mirror                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - Timers owned locally (for master rules)                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - stdin/stdout to UHN Master Node                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - No MQTT, no REST, no WS, no devices                            â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ MQTT bridge (bi-directional)
                                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        UHN EDGE #1       â”‚               â”‚        UHN EDGE #N            â”‚
â”‚           (Go)           â”‚               â”‚           (Go)                â”‚
â”‚                          â”‚               â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ MQTT Broker (local) â”‚â—€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â–¶â”‚ MQTT Broker (local)        â”‚â”‚
â”‚  â”‚ (bridged to master) â”‚ â”‚               â”‚ â”‚ (bridged to master)        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                          â”‚               â”‚                               â”‚
â”‚  - Device I/O            â”‚               â”‚ - Device I/O                  â”‚
â”‚  - Local state           â”‚               â”‚ - Local state                 â”‚
â”‚  - Local timers          â”‚               â”‚ - Local timers                â”‚
â”‚                          â”‚               â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Go Sandbox Launcher â”‚ â”‚               â”‚ â”‚ Go Sandbox Launcher        â”‚â”‚
â”‚  â”‚                     â”‚ â”‚               â”‚ â”‚                            â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚               â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚ â”‚ WORKER          â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ WORKER                  â”‚â”‚â”‚
â”‚  â”‚ â”‚ (Node.js)       â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ (Node.js)               â”‚â”‚â”‚
â”‚  â”‚ â”‚ sandboxed       â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ sandboxed               â”‚â”‚â”‚
â”‚  â”‚ â”‚                 â”‚ â”‚ â”‚               â”‚ â”‚ â”‚                         â”‚â”‚â”‚
â”‚  â”‚ â”‚ - Executes      â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ - Executes              â”‚â”‚â”‚
â”‚  â”‚ â”‚   edge rules    â”‚ â”‚ â”‚               â”‚ â”‚ â”‚   edge rules            â”‚â”‚â”‚
â”‚  â”‚ â”‚ - Read-only     â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ - Read-only             â”‚â”‚â”‚
â”‚  â”‚ â”‚   state mirror  â”‚ â”‚ â”‚               â”‚ â”‚ â”‚   state mirror          â”‚â”‚â”‚
â”‚  â”‚ â”‚ - Timers local  â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ - Timers local          â”‚â”‚â”‚
â”‚  â”‚ â”‚ - stdin/stdout  â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ - stdin/stdout          â”‚â”‚â”‚
â”‚  â”‚ â”‚ - no MQTT       â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ - no MQTT               â”‚â”‚â”‚
â”‚  â”‚ â”‚ - no REST/WS    â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ - no REST/WS            â”‚â”‚â”‚
â”‚  â”‚ â”‚ - no devices    â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ - no devices            â”‚â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚               â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



## Dev setup

Install tools:

```sh
go install github.com/air-verse/air@$(go list -m -f '{{.Version}}' github.com/air-verse/air)
```

or just `make install-tools`

## Development environment

Starts the development server in a tmux session with multiple windows for different services

`make dev`

Press `Ctrl-b + d` to detach the session, then run the following command to stop the development server:

`make dev-stop`

Can mouse copy when holding shift down

Uses go Air for go watch devserver.sh start mqtt in docker uhn runs locally

## Docker

To run dev in docker using rtu simulation software `docker compose --profile dev up --build` or `make docker-dev`

To run dev-real in docker using real rtu devices `docker compose --profile dev-real up --build` or `make docker-dev`-real

To build prod images `docker compose --profile prod build` or `make docker-build`

## MQTT

To tail messages

`docker exec -it uhn-mosquitto sh -c 'apk add --no-cache mosquitto-clients >/dev/null 2>&1 || true; mosquitto_sub -h localhost -t "uhn/#" -v'`

## Tools

To see the base64 binary data as bits `echo AQ== | base64 -d | od -An -t u1`

make build-uhn-tools

./bin/uhn-monitor

./bin/uhnctl push --edge edge1 --device io_kitchen --address 7 --value 1

## Simulator

Rest interface

```sh
# Get whole device state

curl -s http://localhost:8080/device/{busId}/{device}

# Partial update (PATCH semantics)

curl -s -X PATCH http://localhost:8080/device/{busId}/{device} 
  -H 'Content-Type: application/json' 
  -d '{"digitalOutputs":[1,0,0,1],"analogOutputs":[123,456]}'

# Get/set a single digital output

curl -s http://localhost:8080/device/{busId}/{device}/digitalOutput/{i}
curl -s -X PUT http://localhost:8080/device/{busId}/{device}/digitalOutput/{i} 
  -H 'Content-Type: application/json' -d '{"value":1}'

# Toggle a digital output

curl -s -X POST http://localhost:8080/device/{busId}/{device}/digitalOutput/{i}/toggle

# Get/set/toggle/press a digital input

curl -s http://localhost:8080/device/{busId}/{device}/digitalInput/{i}
curl -s -X PUT http://localhost:8080/device/{busId}/{device}/digitalInput/{i} 
  -H 'Content-Type: application/json' -d '{"value":1}'
curl -s -X POST http://localhost:8080/device/{busId}/{device}/digitalInput/{i}/toggle
curl -s -X POST http://localhost:8080/device/{busId}/{device}/digitalInput/{i}/press/tap
curl -s -X POST http://localhost:8080/device/{busId}/{device}/digitalInput/{i}/press/hold1
curl -s -X POST http://localhost:8080/device/{busId}/{device}/digitalInput/{i}/press/hold2

# Analog registers

curl -s http://localhost:8080/device/{busId}/{device}/analogOutput/{i}
curl -s -X PUT http://localhost:8080/device/{busId}/{device}/analogOutput/{i}
  -H 'Content-Type: application/json' -d '{"value":65535}'
```

## Navigating the tmux Environment

- **Detach the tmux Session:** Press `Ctrl+b` and then `d` to detach the session while leaving the processes running.
- Can mouse copy when holding shift down
- **Switch Between Panes:** Use `Ctrl+b` followed by an `arrow key` to switch between panes.
- **Toggle Pane Size:** To make the current pane the whole window, press `Ctrl+b` and then `z`. To toggle back, press `Ctrl+b` and then `z` again.
- **Reattach to the tmux Session:** Run `tmux attach-session -t uhn-dev` or just `devserver.sh start`.
- **Kill the tmux Session:** Exit all panes or kill the session with `tmux kill-session -t uhn-dev` or just `devserver.sh stop`.

`tmux kill-session -t uhn-dev` or just `devserver.sh stop`

`tmux kill-server` Will kill the whole tmux server
